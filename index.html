<html>
<head>
    <link rel="icon" sizes="32x32" href="icon.png">
    <meta charset="utf-8">
    <title>MP5è£åˆ¤è¡¨</title>
<script type="text/javascript">
const tournament={name:null,nickname:null,tbPickable:null,tbPickable:null,tbOnlyOne:null,teamPlayingSize:null,teamData:null,rounds:null,poolMod:null,poolSymbol:null}
// é”¦æ ‡èµ›è®¾ç½®
tournament.rounds={
'å°ç»„èµ›ï¼ˆä¸€ï¼‰':{events:'bpbpppt',pool:`
NM	4149542
	3690812
	4697347
	4189706
	4677366
HD	2610931
	142099
HR	2339362
	4495561
DT	5291424
	1946432
	4593121
FM	5005659
	4457813
TB	5152702
`},
'å°ç»„èµ›ï¼ˆäºŒï¼‰':{events:'bpbpppt',pool:`
NM	5218817
	4765625
	5222606
	2128835
	4683469
HD	2661884
	3880663
HR	4872543
	3356278
DT	5178247
	2908147
	3426783
FM	176549
	2792014
TB	5136969
`},
'æ·˜æ±°èµ›':{events:'bpbppppt',pool:`
NM	4869298
	4928050
	3514184
	3221246
	4858341
	4899113
HD	5041302
	2201077
	2541431
HR	2274048
	5382668
	5133198
DT	5382669
	4018775
	2577469
FM	5250535
	3673913
TB	2381601
`},
/*
'å†³èµ›':{events:'bpbpppppt',pool:`
NM	3643796
	5067635
	3975992
	4939691
	4006177
	4553835
HD	4402317
	4930209
	3588149
HR	1618983
	2992149
	4615282
DT	1553967
	2664535
	2244126
	4864437
FM	4336217
	4755799
	344620
TB	5007747
`},

'':{events:'bpbpppt',pool:`

`},
*/
/*
'è½®æ¬¡å':{events:'bpbpppt',pool:`
ä¸€èˆ¬æ¥è¯´ç›´æ¥å¤åˆ¶å›¾æ± è¡¨çš„mod+bidéƒ¨åˆ†å³å¯
`},
*/
}

tournament.teamData=`
æ°´ä¸‹å±™è±ªä¸€	-Yutori Star-	Cup of Chino	ShikaNai	SparkNights	Zeguqi	NagiSea
ADIOSåè¢«ç¦è¨€ä¸ƒå¤©	Cshck	KentoKanami	-Hokusai-	fate80016	Xeuts
MP5S23æŠ¥åç«çƒ­è¿›è¡Œä¸­	wings_wacr	Memories329	Gua_Zi	Raesin	shuaiyue	sodarose
ä½ å–èŒè¿˜æŒºå‰å®³ï¼Œæ•™æ•™	SzZzC	FireBanana	circle enjoyer	Nana Sakura	___eric___	mike233333
å¸®å¸®æˆ‘ï¼Œé“¶æ²³æ‰§æ³•é˜Ÿ	Delta34301370	evil_01	xgj	GalaxySpeaker	lthreewood	ElicyAnn
Muro Play 5WC	_eleven11	Runick Fountain	m1saka_mikoto	susFries	TheStepAside
è›®æ—å‹‡å£«	-Normal XiGua-	Saykai_	AmeHuyu	BenZn	SINKA0	daring tact
Îµ2S 5dW	H4ppy_n3w_y34r	rainbow03	Astolirey	cd20200816	6C-C6	Dragon-Fox
ãªãªã²ã‚‰ã˜ã‚…ã†ãªãªæ‰	qiao_liang	CloudLinker	feschen	Giggers	-sussycat-	FroZZZZZen
Lemonade Factory	Doubi_wert	DaKaiZi	Romen	Lograys_	WISHATOZ	Levels]
`.trim().split('\n')

tournament.name='ç¬¬äºŒåä¸‰å±ŠMP5æ¯'

tournament.nickname='MP5S23'
    
tournament.tbPickable=false

tournament.tbOnlyOne=true
    
tournament.teamPlayingSize=3

tournament.poolMod={
    NM:'NF',
    HD:'NF HD',
    HR:'NF HR',
    DT:'NF DT',
    FM:'NF FreeMod',
    TB:'NF FreeMod',
}

tournament.poolSymbol={
    NM:'âšª',
    HD:'ğŸŸ¡',
    HR:'ğŸ”´',
    DT:'ğŸŸ£',
    FM:'ğŸ”µ',
    TB:'ğŸŸ¢',
}

// å¤„ç†å›¾æ± 
{
    const modAltNameDict={
        NM:[
            'nm',
            'nomod',
            'no mod',
            'none',
        ],
        HD:[
            'hd',
            'hidden',
        ],
        HR:[
            'hr',
            'hardrock',
            'hard rock',
        ],
        DT:[
            'dt',
            'doubletime',
            'double time',
        ],
        FM:[
            'fm',
            'free',
            'froce',
            'free mod',
            'froce mod',
            'freemod',
            'frocemod',
        ],
        TB:[
            'tb',
            'tiebreaker',
            'tie breaker',
        ],
        EZ:[
            'ez',
            'easy',
        ],
        FL:[
            'fl',
            'flashlight',
            'flash light',
        ],
        HT:[
            'ht',
            'halftime',
            'half time',
        ]
    }
    let modAltName={}
    for(let mod in modAltNameDict)
        for(let altName of modAltNameDict[mod])
            modAltName[altName]=mod

    for(let round in tournament.rounds){
        let pool={}
        let mod='NM'
        for(word of tournament.rounds[round].pool.split(/[\n\t]/)){
            word=word.trim()
            if(!word)continue
            if(word.match(/^-?\d+$/)){
                if(!(mod in pool))pool[mod]=[]
                pool[mod].push(word)
            }else{
                altName=word.toLowerCase()
                mod=(altName in modAltName)?modAltName[altName]:word
            }
        }
        tournament.rounds[round].pool=pool
    }
}
</script>        
<style>
.hidden{
    display: none;
}
#configui { 
    position: fixed; 
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    background-color: rgba(0,0,0,0.5);
    z-index:10;
}
#configui .window { 
    position: fixed; 
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    margin:auto;
    width: 500px; 
    height: 250px; 
    padding: 20px; 
    box-shadow: 3px 3px 10px #404040;
    background-color: white; 
    z-index:20;
}
body{
    background-color:#F3F5F7;
    margin:0;
    font-size:18px;
    line-height: 30px;
}
#body{
    display: flex;
}
#general{
    min-width:300px;
    max-width:300px;
    background-color:white;
    padding:8px;
    padding-top:8px;
    box-shadow: 1px 1px 3px grey;
}
#main{
    height: 100vh;
    overflow: auto;
    width:630px;
}
#assist_pool_out, #assist_player_out{
    background-color: white;
    border-radius: 10px;
    box-shadow: 1px 1px 3px grey;
    padding:6px;
}
#assist_pool_out{
    min-width:170px;
    max-width:170px;
}
#assist_player_out{
    min-width:212px;
    max-width:212px;
}
table{
    font-size:18px;
    line-height: 30px;
}
td{
    vertical-align:top;
}
.part{
    width:575px;
    margin:5px;
    padding:10px;
    box-shadow: 3px 3px 10px grey;
    border-radius: 10px;
    background-color:#EEEEEE;
}
.emoji{
    width:30px;
}
span.emoji{
    width:30px;
    display:inline-block;
}
.part .meta{
    max-width:200px;
    min-width:200px;
}
.part .command{
    min-width:300px;
    max-width:300px;
    background-color: white;
    box-shadow: inset 1px 1px 3px grey;
    padding:5px;
    margin:8px;
    margin-left:20px;
}	
#general .command a{
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.part .meta .key{
    max-width:54px;
    min-width:54px;
}
.part .meta .value{
    max-width:146px;
    min-width:146px;
}
.startup, .settle{
    background-color:#FFFFEE;
}
.ban:nth-child(even){
    background-color:#FFEEEE;
}
.ban:nth-child(odd){
    background-color:#EEEEFF;
}
.pick:nth-child(odd){
    background-color:#FFEEEE;
}
.pick:nth-child(even){
    background-color:#EEEEFF;
}
.magic{
    background-color:#FFFFEE;
}
.tb{
    background-color:#EEFFEE;
}
.title{
    font-weight:bold;
}
.cen{
    text-align: center;
}
.rta{
    text-align: right;
}
.mid{
    margin:auto;
}
button{
    width:100px;
    font-size:18px;
    height:30px;
}
.textarea{
    width:195px;
    padding-left:3px;
    padding-right:3px;
    background-color: white;
    border:1px solid #767676;
    border-radius: 2px;
}
.info-textarea{
    font-family:"Microsoft YaHei";}
select{
    width:146px;
    font-size:18px;
    height:30px;
}
input{
    width:210px;
    font-size:18px;
    height:30px;
}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button {
    -webkit-appearance: none !important;
}
input[type='number'] {
    -moz-appearance: textfield;
}
a{
    text-decoration:none;
    color:black;
    display: block;
    white-space: break-spaces;
}
a:hover{
    background-color: #F4F4F4;
}
.tip-box {
    position: fixed; 
    top: 0;
    bottom: 0;
    font-size: 12px;
    line-height: 12px;
    height: 12px;
    padding: 3px; 
    box-shadow: 1px 1px 3px grey;
    background-color: white; 
    z-index:40;
    display: none;
    user-select: none;
}
#introduction{
    font-size:10px;
    color:#808080;
    padding-top: 4px;
}
#introduction a{
    display:inline !important;
    color:#808080 !important;
}
#introduction a:hover{
    background-color:white !important;
    color: #A0A0A0 !important;
}
</style>
</head>
<body>
<div class="tip-box">å¤åˆ¶æˆåŠŸ</div>
<div id="body">
<div id="configui">
<div class="window">
    <table cellspacing="0">
        <tr><td style="width:210px">ğŸŸ¥ çº¢é˜Ÿ</td><td style="width:80px"></td><td style="width:210px" class="rta">è“é˜Ÿ ğŸŸ¦</td></tr>
        <tr>
            <td><select class="team" style="width:210px"><option value="">è¯·é€‰æ‹©</option></select></td>
            <td class="cen">é¢„è®¾</td>
            <td><select class="team rta" style="width:210px"><option value="">è¯·é€‰æ‹©</option></select></td>
        </tr>
        <tr class="name"><td><input class="red" type="text" value="çº¢é˜Ÿ"></td><td class="cen">é˜Ÿå</td><td><input class="blue rta" type="text" value="è“é˜Ÿ"></td></tr>
        <tr class="cap"><td><input class="red" type="text"></td><td class="cen">é˜Ÿé•¿</td><td><input class="blue rta" type="text"></td></tr>
    </table>
    <hr>
    <table cellspacing="0" class="mid">
        <tr><td style="width:54px;text-align: right">è½®æ¬¡ï¼š</td><td style="width:135px"><select class="round" style="width:135px"></select></td></tr>
    </table>
    <hr>
    <table cellspacing="0" class="mid">
        <tr><td style="width:175px" class="cen"><button>ç¡®å®š</button></td>
            <td style="width:175px" class="cen"><button disabled>å–æ¶ˆ</button></td></tr>
    </table>
    <div id="introduction">é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/mp5tournament/referee_sheet" target="_blank">https://github.com/mp5tournament/referee_sheet</a></div>
</div></div>

<div class="hidden">
    <div class="part startup"><table cellspacing="0"><tr>
        <td class="emoji">âŒ›</td>
        <td class="meta"><table cellspacing="0"><tr><td class="title" colspan="2">èµ›å‰èµ›åˆå‡†å¤‡</td></tr>
            <tr><td class="key">å…ˆé€‰ï¼š</td><td class="value"><select class="team" onchange="partOnChange(this)">
                           <option value="">è¯·é€‰æ‹©</option>
                           <option value="red">ğŸŸ¥çº¢é˜Ÿ</option>
                           <option value="blue">ğŸŸ¦è“é˜Ÿ</option>
                   </select></td></tr>
            <tr><td class="key">MIDï¼š</td><td class="value"><input style="width:146px" placeholder="é€‰å¡« MPLinkæˆ–ID" onchange="partOnChange(this)"></td></tr>
            <tr><td colspan="2">å¤‡æ³¨</td></tr>
            <tr><td colspan="2"><div class="textarea" contenteditable="true"></div></td></tr>
        </table></td>
        <td class="commandout"><div class="command"></div></td>
    </tr></table></div>

    <div class="part ban hidden" cellspacing="0"><table cellspacing="0"><tr>
        <td class="emoji">ğŸš«</td>
        <td class="meta"><table cellspacing="0"><tr><td class="title" colspan="2"><span class="v_color"></span>ç¦å›¾</td></tr>
            <tr><td class="key">ç¦å›¾ï¼š</td><td class="value"><select class="map" onchange="partOnChange(this)"></select></td></tr>
            <tr><td colspan="2">å¤‡æ³¨</td></tr>
            <tr><td colspan="2"><div class="textarea" contenteditable="true"></div></td></tr>
        </table></td>
        <td class="commandout"><div class="command"></div></td>
    </tr></table></div>

    <div class="part pick hidden" cellspacing="0"><table cellspacing="0"><tr>
        <td class="emoji">âš”ï¸</td>
        <td class="meta"><table cellspacing="0"><tr><td class="title" colspan="2"><span class="v_color"></span>é€‰å›¾</td></tr>
            <tr><td class="key">é€‰å›¾ï¼š</td><td class="value"><select class="map" onchange="partOnChange(this)"></select></td></tr>
            <tr><td class="key">èƒœè€…ï¼š</td><td class="value"><select class="team" onchange="partOnChange(this)">
                           <option value="">è¯·é€‰æ‹©</option>
                           <option value="red">ğŸŸ¥çº¢é˜Ÿ</option>
                           <option value="blue">ğŸŸ¦è“é˜Ÿ</option>
                   </select></td></tr>
            <tr><td colspan="2">å¤‡æ³¨</td></tr>
            <tr><td colspan="2"><div class="textarea" contenteditable="true"></div></td></tr>
        </table></td>
        <td class="commandout"><div class="command"></div></td>
    </tr></table></div>
    
    <div class="part tb hidden" cellspacing="0"><table cellspacing="0"><tr>
        <td class="emoji">âš”ï¸</td>
        <td class="meta"><table cellspacing="0"><tr><td class="title" colspan="2">TB</td></tr>
            <tr class="selectTB"><td class="key">é€‰å›¾ï¼š</td><td class="value"><select class="map" onchange="partOnChange(this)"></select></td></tr>
            <tr><td class="key">èƒœè€…ï¼š</td><td class="value"><select class="team" onchange="partOnChange(this)">
                           <option value="">è¯·é€‰æ‹©</option>
                           <option value="red">ğŸŸ¥çº¢é˜Ÿ</option>
                           <option value="blue">ğŸŸ¦è“é˜Ÿ</option>
                   </select></td></tr>
            <tr><td colspan="2">å¤‡æ³¨</td></tr>
            <tr><td colspan="2"><div class="textarea" contenteditable="true"></div></td></tr>
        </table></td>
        <td class="commandout"><div class="command"></div></td>
    </tr></table></div>

    <div class="part settle hidden"><table cellspacing="0"><tr>
        <td class="emoji">ğŸ…</td>
        <td class="meta"><table cellspacing="0"><tr><td class="title" colspan="2">æ¯”èµ›ç»“æŸ</td></tr>
            <tr><td colspan="2">å¤‡æ³¨</td></tr>
            <tr><td colspan="2"><div class="textarea" contenteditable="true"></div></td></tr>
        </table></td>
        <td class="commandout"><div class="command"></div></td>
    </tr></table></div>

    <table>
        <tr class="assist_pool_line"><td style="width:80px" class="pos"></td><td style="width:50px"><a class="map"></a></td><td style="width:50px"><a class="mod"></a></td></tr>
        <tr class="assist_player_line"><td style="width:200px"><a></a></td></tr>
    </table>
</div>

<div id="general">
    <a id="config" href="javascript:void(0)"><span class="emoji">âš™ï¸</span>è®¾ç½®</a>
    <a id="show_assist_pool" href="javascript:void(0)"><span class="emoji">ğŸ‘€</span><span id="show_assist_pool_statu">æ˜¾ç¤º</span>å…¨éƒ¨å›¾æ± æŒ‡ä»¤</a>
    <a id="show_assist_player" href="javascript:void(0)"><span class="emoji">ğŸ‘€</span><span id="show_assist_player_statu">æ˜¾ç¤º</span>å…¨éƒ¨é˜Ÿå‘˜é‚€è¯·æŒ‡ä»¤</a>
    <hr>
    <a id="export" href="javascript:void(0)"><span class="emoji">ğŸ’¾</span>ä¿å­˜æ¯”èµ›è®°å½•</a>
    <a id="copy_mainsheet_text" href="javascript:void(0)"><span class="emoji">ğŸ“‘</span>å¤åˆ¶ä¸»è¡¨æ ¼ä¿¡æ¯</a>
    <hr>
    <div><span class="emoji">ğŸ†</span><span class="v_tournament"></span></div>
    <div><span class="emoji">ğŸ“Œ</span><span class="v_round"></span></div>
    <div><span class="emoji">ğŸŸ¥</span><span class="v_red"></span></div>
    <div><span class="emoji">ğŸŸ¦</span><span class="v_blue"></span></div>
    <hr>
    <div class="command"></div>
</div>
<div id="main">
</div>
<div id="assist_pool_out" class="hidden">
    <table id="assist_pool"></table>
</div>
<div id="assist_player_out" class="hidden">
    <table id="assist_player"></table>
</div>
</div>
<script type="text/javascript">
// å‘½ä»¤è®¾ç½®
const part={
    startup:[
        `!MP MAKE ${tournament.nickname}: ({red}) vs ({blue})`,
        '!MP SET 2 3',
        '!MP MAP {tb_bid}',
        '!MP INVITE {red_cap}',
        '!MP INVITE {blue_cap}',
        '!MP ADDREF',
        `çº¢é˜Ÿï¼š{red}ï¼Œ1-${tournament.teamPlayingSize}æ¥¼ï¼›è“é˜Ÿï¼š{blue}ï¼Œ${tournament.teamPlayingSize+1}-${tournament.teamPlayingSize*2}æ¥¼`,
        'è¯·åŒæ–¹é˜Ÿé•¿rollç‚¹å†³å®šBPé¡ºåºï¼Œç‚¹å¤§è€…å…ˆé€‰ï¼Œç‚¹å°è€…å…ˆban',
        '',
        'å…ˆé€‰æ–¹ä¸º {fp_t}ï¼Œå…ˆbanæ–¹ä¸º {fb_t}ã€‚',
    ],
    ban:[
        'è¯· {team} banå›¾',
        '!MP TIMER 90',
        '',
        '{team} ban {map}',
        '!MP MAP {bid}',
    ],
    pick:[
        'è¯· {team} é€‰å›¾',
        '!MP TIMER 120',
        '',
        '!MP MAP {bid}',
        '!MP MODS {mod}',
        '!MP TIMER 120',
        '',
        '{red} {sr}:{sb} {blue}',
    ],
    tb:tournament.tbOnlyOne?[
        'åŒæ–¹å‡å–å¾—èµ›ç‚¹ï¼Œæ¯”èµ›å³å°†è¿›å…¥TBã€‚',
        '!MP MAP {bid}',
        '!MP MODS {mod}',
        '!MP TIMER 240',
        '',
        '{red} {sr}:{sb} {blue}',
    ]:[
        'åŒæ–¹å‡å–å¾—èµ›ç‚¹ï¼Œæ¯”èµ›å³å°†è¿›å…¥TBã€‚è¯·åŒæ–¹åˆ†åˆ«ç§èŠæˆ‘æƒ³è¦bançš„å›¾ã€‚',
        'åŒæ–¹å‡å–å¾—èµ›ç‚¹ï¼Œæ¯”èµ›å³å°†è¿›å…¥TBã€‚',
        '',
        '!MP MAP {bid}',
        '!MP MODS {mod}',
        '!MP TIMER 240',
        '',
        '{red} {sr}:{sb} {blue}',
    ],
    settle:[
        'æ­å–œ{team}è·èƒœ',
        '!MP CLOSE',
        'ï¼ˆè¯·è£åˆ¤åˆ«å¿˜äº†å¡«ä¸»è¡¨æ ¼å“¦ï¼‰',
    ],
    general:[
        '!MP TIMER 120',
        '!MP TIMER 90',
        '!MP TIMER 60',
        '!MP SETTINGS',
        '!MP START 7',
        '!MP ABORT',
        '',
        '{red} è¶…æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ç¬¬ä¸€æ¬¡æš‚åœã€‚å‰©ä½™ä¸€æ¬¡æš‚åœã€‚',
        '{blue} è¶…æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ç¬¬ä¸€æ¬¡æš‚åœã€‚å‰©ä½™ä¸€æ¬¡æš‚åœã€‚',
        '{red} å†æ¬¡è¶…æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ç¬¬äºŒæ¬¡æš‚åœã€‚è¯¥é˜Ÿæš‚åœæœºä¼šå·²ç”¨å®Œï¼Œè¯·å‹¿å†æ¬¡è¶…æ—¶ã€‚',
        '{blue} å†æ¬¡è¶…æ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨ç¬¬äºŒæ¬¡æš‚åœã€‚è¯¥é˜Ÿæš‚åœæœºä¼šå·²ç”¨å®Œï¼Œè¯·å‹¿å†æ¬¡è¶…æ—¶ã€‚',
    ]
}

// æ­£æ–‡
function changeAll(fatherNode,varName,text){
    text=esc(String(text))
    for(node of fatherNode.getElementsByClassName('v_'+varName)) node.innerHTML=text
}
changeAll(document,'tournament',tournament.name)

function esc(s){
    s = s.replace(/&/g,"&amp;")
    s = s.replace(/</g,"&lt;")
    s = s.replace(/>/g,"&gt;")
    s = s.replace(/ã€€/g,"&emsp;")
    s = s.replace(/\'/g,"&#39;")
    s = s.replace(/\"/g,"&quot;")
    return s
}
const main=document.getElementById('main')
const general=document.getElementById('general')
const assistPoolOut=document.getElementById('assist_pool_out')
const assistPool=document.getElementById('assist_pool')
const assistPlayerOut=document.getElementById('assist_player_out')
const assistPlayer=document.getElementById('assist_player')
const configui=document.getElementById('configui')
let config=null
let showAssistPool=false
let showAssistPlayer=false
document.getElementById('show_assist_pool').onclick=function(){
    if(showAssistPool){
        showAssistPool=false
        document.getElementById('show_assist_pool_statu').textContent='æ˜¾ç¤º'
        assistPoolOut.classList.add('hidden')
    }else{
        showAssistPool=true
        document.getElementById('show_assist_pool_statu').textContent='éšè—'
        assistPoolOut.classList.remove('hidden')
    }
}
document.getElementById('show_assist_player').onclick=function(){
    if(showAssistPlayer){
        showAssistPlayer=false
        document.getElementById('show_assist_player_statu').textContent='æ˜¾ç¤º'
        assistPlayerOut.classList.add('hidden')
    }else{
        showAssistPlayer=true
        document.getElementById('show_assist_player_statu').textContent='éšè—'
        assistPlayerOut.classList.remove('hidden')
    }
}
const assistPoolLine=document.getElementsByClassName('assist_pool_line')[0]
const assistPlayerLine=document.getElementsByClassName('assist_player_line')[0]

// å¤åˆ¶å‘½ä»¤
{
    const mouse={x:0,y:0}
    const box0=document.getElementsByClassName('tip-box')[0]
    document.addEventListener('click', function(event){
        mouse.x = event.clientX
        mouse.y = event.clientY
    })
    function copyText(x,y=null){
        const input = document.createElement('textarea')
        document.body.appendChild(input)
        input.innerHTML = y || x.title || x.textContent
        input.select()
        document.execCommand('Copy')
        document.body.removeChild(input)

        setTimeout(function(){
            const box = box0.cloneNode(true)
            document.body.appendChild(box)
            box.style.left = mouse.x + 'px'
            box.style.top = mouse.y + 'px'
            box.style.display = 'block'
            box.style.opacity = 1
            setTimeout(function(){
                box.style.opacity = 0.75
                setTimeout(function(){
                    box.style.opacity = 0.5
                },40)
                setTimeout(function(){
                    box.style.opacity = 0.25
                },80)
                setTimeout(function(){
                    box.style.opacity = 0
                    document.body.removeChild(box)
                },120)
            },500)
        },10)
    }
}

// commands
{
    function loadPart(partName){
        let thisPart=document.getElementsByClassName(partName)[0]
        let commands=part[partName]
        let fatherNode=(partName=='general'?general:thisPart).getElementsByClassName('command')[0]
        for(command of commands){
            if(command){
                let nc=document.createElement('a')
                fatherNode.appendChild(nc)
                nc.setAttribute('href','javascript:void(0)')
                nc.setAttribute('onclick','copyText(this)')
                nc.innerHTML=esc(command).replace(/{/g,'<span class="v_').replace(/}/g,'"></span>')
            }else if(partName=='general'){
                fatherNode.appendChild(document.createElement('hr'))
            }else{
                let nf=document.createElement('div')
                nf.setAttribute('class','step hidden')
                fatherNode.appendChild(nf)
                fatherNode=nf
            }
        }
        part[partName]=thisPart
    }
    for(partName in part)loadPart(partName)
    if(tournament.tbOnlyOne)part.tb.getElementsByClassName('selectTB')[0].classList.add('hidden')
}


// configui
{
    const c_red={
        select:configui.getElementsByTagName('select')[0],
        name:configui.getElementsByClassName('name')[0].getElementsByClassName('red')[0],
        cap:configui.getElementsByClassName('cap')[0].getElementsByClassName('red')[0],
        player:[],
    }
    const c_blue={
        select:configui.getElementsByTagName('select')[1],
        name:configui.getElementsByClassName('name')[0].getElementsByClassName('blue')[0],
        cap:configui.getElementsByClassName('cap')[0].getElementsByClassName('blue')[0],
        player:[],
    }
    const c_round=configui.getElementsByClassName('round')[0]
    const c_button=configui.getElementsByTagName('button')
    for (i in tournament.teamData){
        let team=tournament.teamData[i].split('\t')
        tournament.teamData[i]={name:team[0],cap:team[1],player:team.slice(1)}
        let opt=document.createElement('option')
        opt.setAttribute('value',i)
        c_red.select.add(new Option(team[0],i))
        c_blue.select.add(new Option(team[0],i))
    }
    let last_round=''
    for (round in tournament.rounds){
        c_round.add(new Option(round,round))
        last_round=round
    }
    c_round.value=last_round

    function autoSelect(team){
        let i=parseInt(team.select.value)
        if (i<0){
            team.name.value=team==c_red?'ğŸŸ¥çº¢é˜Ÿ':'ğŸŸ¦è“é˜Ÿ'
            team.cap.value=''
            team.player=[]
        }else{
            team.name.value=tournament.teamData[i].name
            team.cap.value=tournament.teamData[i].cap
            team.player=tournament.teamData[i].player
        }
    }
    c_red.select.onchange=function(){
        autoSelect(c_red)
    }
    c_blue.select.onchange=function(){
        autoSelect(c_blue)
    }

    c_button[0].onclick=function(){
        if(config){
            if(!confirm("ä¿®æ”¹è®¾ç½®å°†å¯¼è‡´é¡µé¢é‡æ–°åˆå§‹åŒ–ï¼Œå·²å¡«å†™çš„ä¿¡æ¯ä¸¢å¤±ï¼Œä½ ç¡®å®šè¦è¿™ä¹ˆåšå—ï¼Ÿ"))return
        }else{
            c_button[1].removeAttribute('disabled')
        }
        init()
        configui.classList.add('hidden')
    }
    c_button[1].onclick=function(){
        configui.classList.add('hidden')
    }
    document.getElementById('config').onclick=function(){configui.classList.remove('hidden')}

    function reloadConfig(){
        let round=tournament.rounds[c_round.value]
        let pool={}
        for(mod in round.pool){
            let pickable=[false,false,false]
            if(mod=='TB'){
                pickable[2]=true
                if(tournament.tbPickable)pickable[1]=true
            }else{
                pickable[0]=true
                pickable[1]=true
            }
            if(round.pool[mod].length>1) for(i in round.pool[mod]){
                pool[mod+(parseInt(i)+1)]={bid:round.pool[mod][i],mod:tournament.poolMod[mod],symbol:tournament.poolSymbol[mod],pickable}
            }
            if(round.pool[mod].length==1){
                pool[mod]={bid:round.pool[mod][0],mod:tournament.poolMod[mod],symbol:tournament.poolSymbol[mod],pickable}
            }
        }

        let tb=null
        if(pool.TB) tb=pool.TB.bid
        else if(pool.TB1) tb=pool.TB1.bid
        else for(let map in pool){
            tb=pool[map].bid
            break
        }

        config={
            round:c_round.value,
            red:{
                name:c_red.name.value,
                cap:c_red.cap.value,
                player:c_red.player,
            },
            blue:{
                name:c_blue.name.value,
                cap:c_blue.cap.value,
                player:c_blue.player,
            },
            events:round.events,
            gamestowin:round.events.replaceAll('b','').length,
            pool,
            tb,
        }
    }
}

// ä¿å­˜æ¯”èµ›è®°å½•
{
    document.getElementById('export').onclick=function(){
        if(!config)return
        let =general.getElementsByClassName('v_tournament')[0].textContent
        let mplink=events[0].dom.getElementsByTagName('input')[0].value.split('/')
        for(i=mplink.length-1;i>=0;i--)if(mplink[i])
        {
            mplink=mplink[i]
            break
        }
        mplink=typeof(mplink)=='string'?`https://osu.ppy.sh/community/matches/${mplink}\n`:''

        let ban={çº¢é˜Ÿ:'ğŸŸ¥ban',è“é˜Ÿ:'ğŸŸ¦ban'}
        let pick=''
        let sr=''
        let sb=''
        let scmd=''
        for(event of events){
            if(event.dom.classList.contains('hidden'))continue
            const cmd=event.dom.getElementsByClassName('textarea')[0].textContent
            if(event.type=='startup'){
                scmd=`${cmd?`ï¼ˆ${cmd}ï¼‰\n`:''}`
            }else if(event.type=='ban'){
                ban[event.color]+=` ${event.map=='0'?'ç©º':event.map}${cmd?`ï¼ˆ${cmd}ï¼‰`:''}`
            }else if(event.type=='pick'){
                pick+=`${event.win=='red'?'ğŸŸ¥':'ğŸŸ¦'}|${event.color=='çº¢é˜Ÿ'?'ğŸŸ¥':'ğŸŸ¦'} ${event.map}${cmd?`ï¼ˆ${cmd}ï¼‰`:''}\n`
            }else if(event.type=='tb'){
                pick+=`${event.win=='red'?'ğŸŸ¥':'ğŸŸ¦'}|ğŸŸ© ${event.map}${cmd?`ï¼ˆ${cmd}ï¼‰`:''}\n`
            }else if(event.type=='settle'){
                sr=event.sr
                sb=event.sb
                pick+=`${sr>sb?`ğŸŸ¥${config.red.name}`:`ğŸŸ¦${config.blue.name}`}è·èƒœï¼${cmd?`ï¼ˆ${cmd}ï¼‰`:''}\n`
            }
        }
        ban=firstPick=='red'?`${ban['è“é˜Ÿ']}\n${ban['çº¢é˜Ÿ']}`:`${ban['çº¢é˜Ÿ']}\n${ban['è“é˜Ÿ']}`
        title=`${tournament.name} ${config.round} ${config.red.name} vs ${config.blue.name}`
        text=`${tournament.name} ${config.round} \n`
            +`${mplink}\n`
            +`${config.red.name} ${sr}:${sb} ${config.blue.name}\n${scmd}\n`
            +ban
            +`\n\nèƒœ|é€‰\n`
            +pick

        {
            const blob = new Blob([text], {
                type: 'text/plain;charset=utf-8'
            })
            const objectURL = URL.createObjectURL(blob)
            const aTag = document.createElement('a')
            aTag.href = objectURL
            aTag.download = title+'.txt'
            aTag.click()
            URL.revokeObjectURL(objectURL)
        }
    }
}

{
    document.getElementById('copy_mainsheet_text').onclick=function(){
        if(!firstPick)return
        let xxxxxxx=main.getElementsByClassName('meta')[0].getElementsByClassName('team')[0].value
        const banList={red:[],blue:[]}
        for(let partBan of main.getElementsByClassName('part ban'))if(!partBan.classList.contains('hidden')){
            if(partBan.getElementsByClassName('map')[0].value)
                (partBan.getElementsByClassName('v_color')[0].textContent=='è“é˜Ÿ'?banList.blue:banList.red)
                    .push(partBan.getElementsByClassName('map')[0].value)
        }
        copyText(null,`${firstPick=='red'?'çº¢é˜Ÿ':'è“é˜Ÿ'}\t${banList.red.join(' ')}\t${banList.blue.join(' ')}`)
    }
}

let events=[]
let firstPick=null

function allTrue(x){
    for(i of x)if(!i)return false
    return true
}

const firstPickRegulator=document.createElement('div')
firstPickRegulator.setAttribute('class','part hidden')

function makeFinish(n,finish=true,settle=false){
    n=parseInt(n)
    const event=events[n]
    const l=events.length-1
    if(finish){
        event.finish=true
        if(settle){
            for(i=n+1;i<l;i++)events[i].dom.classList.add('hidden')
            events[l].sr=events[n].sr
            events[l].sb=events[n].sb
            partOnChange(null,l)
        }else partOnChange(null,n+1)
    }else{
        event.finish=false
        for(i=n+1;i<=l;i++)events[i].dom.classList.add('hidden')
    }
}

function partOnChange(thisPart,n=null){
    if(n===null){
        while(!thisPart.classList.contains('part')){
            thisPart=thisPart.parentNode
        }
        for(i in events)if(events[i].dom==thisPart){
            n=i
            break
        }
    }
    n=parseInt(n)
    let event=events[n]
    event.dom.classList.remove('hidden')
    let values={}
    let steps=[]
    if(event.type=='startup'){
        window.onbeforeunload=function(){
            return 'ç¡®è®¤è¦é€€å‡ºå—ï¼Ÿ'
        }

        event.sr=0
        event.sb=0

        firstPick=event.dom.getElementsByTagName('select')[0].value

        try{
            if(firstPick=='red') main.insertBefore(firstPickRegulator,event.dom)
            if(firstPick=='blue') main.removeChild(firstPickRegulator)
        }catch{}

        if(firstPick){
            let firstBan=firstPick=='red'?'blue':'red'
            values.fp_t=`${config[firstPick].name}ï¼ˆ${firstPick=='red'?'çº¢é˜Ÿ':'è“é˜Ÿ'}ï¼‰`
            values.fb_t=`${config[firstBan].name}ï¼ˆ${firstBan=='red'?'çº¢é˜Ÿ':'è“é˜Ÿ'}ï¼‰`
            let x=firstPick=='red'?1:0
            for(i in events){
                let y=null
                if(events[i].type=='ban')y=1
                if(events[i].type=='pick')y=0
                if(y===null)continue
                events[i].color=i&1^x^y?'è“é˜Ÿ':'çº¢é˜Ÿ'
                events[i].team=i&1^x^y?config.blue.name:config.red.name
            }
        }

        steps=[firstPick!='']
    } else if(event.type=='ban'){
        event.sr=events[n-1].sr
        event.sb=events[n-1].sb

        values.color=event.color
        values.team=event.team
        values.map=event.dom.getElementsByTagName('select')[0].value
        event.map=values.map
        if(values.map){
            values.bid=values.map=='0'?'ç©º':config.pool[values.map].bid
        }

        steps=[values.map!='']
    } else if(event.type=='pick'){
        event.sr=events[n-1].sr
        event.sb=events[n-1].sb

        values.color=event.color
        values.team=event.team
        values.map=event.dom.getElementsByTagName('select')[0].value
        event.map=values.map
        if(values.map){
            values.bid=config.pool[values.map].bid
            values.mod=config.pool[values.map].mod
        }
        values.win=event.dom.getElementsByTagName('select')[1].value
        event.win=values.win
        if(values.win=='red')event.sr+=1
        if(values.win=='blue')event.sb+=1
        values.sr=event.sr
        values.sb=event.sb

        steps=[values.map!='',values.win!='']
    } else if(event.type=='tb'){
        event.sr=events[n-1].sr
        event.sb=events[n-1].sb
        values.win=event.dom.getElementsByTagName('select')[1].value
        event.win=values.win
        if(values.win=='red')event.sr+=1
        if(values.win=='blue')event.sb+=1
        values.sr=event.sr
        values.sb=event.sb
        
        if(tournament.tbOnlyOne){
            values.map=event.dom.getElementsByTagName('select')[0].options[1].value
            event.map=values.map
            if(values.map){
                values.bid=config.pool[values.map].bid
                values.mod=config.pool[values.map].mod
            }
            steps=[values.win!='']
        }else{
            values.map=event.dom.getElementsByTagName('select')[0].value
            event.map=values.map
            if(values.map){
                values.bid=config.pool[values.map].bid
                values.mod=config.pool[values.map].mod
            }
            steps=[values.map!='',values.win!='']
        }
    } else if(event.type=='settle'){
        values.team=event.sr>event.sb?config.red.name:config.blue.name
    }

    for(key in values)changeAll(event.dom,key,values[key])
    for(i in steps){
        const nodeClass=event.dom.getElementsByClassName('step')[i].classList
        if(steps[i])nodeClass.remove('hidden')
        else nodeClass.add('hidden')
    }
    if(event.type!='settle')makeFinish(n,allTrue(steps),event.sr>=config.gamestowin||event.sb>=config.gamestowin)
}

function addEvent(type){
    dom=part[type].cloneNode(true)
    main.appendChild(dom)
    events.push({dom,type,finish:false,sr:null,sb:null})
}

function init(){
    reloadConfig()

    {
        const b=part.ban.querySelector('select.map')
        const p=part.pick.querySelector('select.map')
        const t=part.tb.querySelector('select.map')
        b.innerHTML=''
        p.innerHTML=''
        t.innerHTML=''
        b.add(new Option('è¯·é€‰æ‹©',''))
        b.add(new Option('âŒç©ºban',0))
        p.add(new Option('è¯·é€‰æ‹©',''))
        t.add(new Option('è¯·é€‰æ‹©',''))
        for(map in config.pool){
            if(config.pool[map].pickable[0])b.add(new Option(config.pool[map].symbol+map,map))
            if(config.pool[map].pickable[1])p.add(new Option(config.pool[map].symbol+map,map))
            if(config.pool[map].pickable[2])t.add(new Option(config.pool[map].symbol+map,map))
        }
    }
    
    changeAll(document,'round',config.round)
    changeAll(document,'red',config.red.name)
    changeAll(document,'blue',config.blue.name)
    changeAll(document,'tb_bid',config.tb)
    changeAll(document,'red_cap',config.red.cap)
    changeAll(document,'blue_cap',config.blue.cap)

    events=[]
    while(main.firstChild)main.removeChild(main.firstChild)

    assistPool.innerHTML=''
    for(map in config.pool){
        let nl=assistPoolLine.cloneNode(true)

        let ncPos=nl.getElementsByClassName('pos')[0]
        ncPos.innerHTML=`${config.pool[map].symbol}${map}`
        let ncMap=nl.getElementsByClassName('map')[0]
        ncMap.setAttribute('href','javascript:void(0)')
        ncMap.setAttribute('onclick','copyText(this)')
        ncMap.setAttribute('title',`!MP MAP ${config.pool[map].bid}`)
        ncMap.innerHTML='MAP'
        let ncMod=nl.getElementsByClassName('mod')[0]
        ncMod.setAttribute('href','javascript:void(0)')
        ncMod.setAttribute('onclick','copyText(this)')
        ncMod.setAttribute('title',`!MP MODS ${config.pool[map].mod}`)
        ncMod.innerHTML='MOD'

        assistPool.appendChild(nl)
    }

    assistPlayer.innerHTML=''
    function addAssistPlayerLine(player,pre=''){
        let nl=assistPlayerLine.cloneNode(true)
        let ncA=nl.getElementsByTagName('a')[0]
        if(player){
            ncA.setAttribute('href','javascript:void(0)')
            ncA.setAttribute('onclick','copyText(this)')
            ncA.setAttribute('title', `!MP INVITE ${player}`)
        }
        ncA.innerHTML=pre+player
        assistPlayer.appendChild(nl)
    }
    for(player of config.red.player)addAssistPlayerLine(player,'<span class="emoji">ğŸŸ¥</span>')
    for(player of config.blue.player)addAssistPlayerLine(player,'<span class="emoji">ğŸŸ¦</span>')

    addEvent('startup')
    for(event of config.events){
        if(event=='b'){
            addEvent('ban')
            addEvent('ban')
        } else if(event=='p'){
            addEvent('pick')
            addEvent('pick')
        } else if(event=='t'){
            addEvent('tb')
        }
    }
    addEvent('settle')
}
</script>
</body>
</html>
